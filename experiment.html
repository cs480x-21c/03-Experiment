<script src="https://d3js.org/d3.v4.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js" integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous"></script>

<script>


</script>

<body>

  <ul class="nav" style="background-color: #e3f2fd;">
    <li class="nav-item">
      <a class="nav-link active" aria-current="page" href="index.html">Home</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" href="experiment.html">Restart</a>
  </ul>

</body>

<div id="vis"></div>

<script>
  console.log(d3); // test if d3 is loaded

  // count for each type of plot
  var result = {}
  var type0_count = 0
  var type1_count = 0
  var type2_count = 0
  var total = 0

  // Generates random ints from 0-max
  function getRandomInt(max) {
    return Math.floor(Math.random() * Math.floor(max));
  }

  onButtonClick()

  // clear prior chart, pick chart type, draw chart.
  function onButtonClick(isValue){
    console.log("click")

    // save their percentage value
    if (isValue == 1) {
      var input = document.getElementById("inputValue").value
      // document.getElementById("inputValue")
      result[total].push(input)
      console.log("input: ", input)
    }
    
    // remove prior chart
    d3.select("svg").remove()

    // set the dimensions and margins of the graph
    var margin = {top: 30, right: 30, bottom: 70, left: 60},
      width = 460 - margin.left - margin.right,
      height = 400 - margin.top - margin.bottom;

    // append the svg object to the body of the page
    var svg = d3.select("#vis")
      .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .attr("id", "visSvg")
      .append("g")
        .attr("transform",
              "translate(" + margin.left + "," + margin.top + ")");
            
    // Generate 5 random points from 0-100
    // [[0, value],[1, value], ... [4, value]]
    var data = [];
      for (var i = 0; i < 5; i++) {
        var rand_height = getRandomInt(100);
        var point = [i, rand_height]
        data.push(point)
      }
      console.log(data)

    // randomly pick two bar indices to conduct experiment on
    var rand_point_1 = Math.floor(Math.random() * 5)
    var rand_point_2 = Math.floor(Math.random() * 5)
    while (rand_point_2 == rand_point_1) {
      var rand_point_2 = Math.floor(Math.random() * 5)
    }

    grayscale_pallete = ['#999999', '	#777777', '#555555','#333333', '#111111']
    colorblind_pallete = ['#44AA99', '#88CCEE', '#DDCC77', '#CC6677', '#AA4499']

    // pick chart type
    if (type0_count < 1 || type1_count < 1 || type2_count < 1) {
      options = []
      if (type0_count < 20) {options.push("type0")}
      if (type1_count < 20) {options.push("type1")}
      if (type2_count < 20) {options.push("type2")}
      
      // randomly pick one available type
      type_index = Math.floor(Math.random() * options.length)

      if (options[type_index] == "type0") {
        type0_count++
        type = 0
        type_name = "black"
      }

      if (options[type_index] == "type1") {
        type1_count++
        type = 1
        type_name = "grayscale"
      }

      if (options[type_index] == "type2") {
        type2_count++
        type = 2
        type_name = "color"

      }

      total += 1
    }
    else {

      // Exit
      

      console.log(result)
      var dictresult = JSON.stringify(result)
      console.log(dictresult)
      // var file = new File(dictresult, "result_csv");
      var blobresult = new Blob([dictresult])
      console.log(blobresult)
      var objectURL = window.webkitURL.createObjectURL(blobresult)
      console.log(objectURL)
      // var encodedUri = encodeURI(dictresult);
      // window.open(encodedUri);

      
      // document.getElementById("finished").click()

      // var fs = require('fs')
      // fs.writeFile("result.json", dictresult)

      return
    }

    console.log(type, total, type0_count, type1_count, type2_count)

    // draw the Chart

    // X axis
    var x = d3.scaleBand()
      .range([ 0, width ])
      .domain(data.map(function(d) { return d[0] }))
      .padding(0.2);
    svg.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x).tickSize(0))
      .selectAll("text")
        .style("opacity", 0);

    // Add Y axis
    var y = d3.scaleLinear()
      .domain([0, 100])
      .range([ height, 0]);
    svg.append("g")
      .call(d3.axisLeft(y).tickSize(0))
      .selectAll("text")
        .style("opacity", 0)

    // Bars
    svg.selectAll("mybar")
      .data(data)
      .enter()
      .append("rect")
        .attr("x", function(d) { return x(d[0])})
        .attr("y", function(d) { return y(d[1])})
        .attr("width", 35)
        .attr("height", function(d) { return height - y(d[1]) })
        .attr("fill", function(d) { 
          if (type == 0)
            return 'black'
          else if (type == 1)
            return grayscale_pallete[d[0]]
          else if (type == 2)
            return colorblind_pallete[d[0]]
          })
    
    svg.append('circle')
      .attr('cx', function(d) { return x(data[rand_point_1][0]) + 18})
      .attr('cy', y(-5))
      .attr('r', 5)
      .style('fill', 'black')

    svg.append('circle')
      .attr('cx', function(d) { return x(data[rand_point_2][0]) + 18})
      .attr('cy', y(-5))
      .attr('r', 5)
      .style('fill', 'black')
    
    var val1 = data[rand_point_1][1]
    var val2 = data[rand_point_2][1]
    
    if (val1 == 0 && val2 == 0) {
      percentage = 1
    }
    if (val1 == 0 || val2 == 0) {
      percentage == 0
    }
    if (val1 < val2) {
      var percentage = val1/val2
    }
    if (val2 < val1) {
      var percentage = val2/val1
    }
    if (val1 == val2) {
      var percentage = 1
    }

    percentage = Math.round(percentage * 100)

    result[total] = [type_name, percentage]
  } 

</script>

<body>

  <div class="p-5">
    <div class="row g-3 align-items-center">

      <div class="col-auto">
        <input type="text" id="inputValue" class="form-control" aria-describedby="ValueHelpInline">
      </div>

      <div class="col-auto">
        <button type="submit" value="onButtonClick" class="btn btn-primary" onclick="onButtonClick(1)">Next Chart</button>
      </div>

      <span id="ValueHelpInline" class="form-text">
        Input Percentage
      </span>

      <a id="finished" href="finished.html"></a>

    </div>
  </div>
</body>