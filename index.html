<script src="https://d3js.org/d3.v4.min.js"></script>

<style>
</style>

<body>
  <h1> Experiment </h1>
  <label id="labelElement">
    Welcome to the experiment, press some buttons, answer some questions and don't worry your pretty lil head.
  </label>
  <p></p>
  <input id="readyButton" type="button" value="I'm ready to start" onclick="startButtonPress()">
</body>

<div id="vis"></div>

<script>
  // Initialize random data for testing
  let currData = [...Array(10)]
  let currSelectedPoints = [...Array(2)]

  // Keep track of which page/trial we're on
  currTrial = 0
  currTrialType = ''

  // Initialize Array for selecting next chart
  let chooseAChart = [
          makeTreeMap,
          makeStackedBarChart,
          makePieChart,
          makeTreeMap,
          makeStackedBarChart,
          makePieChart
  ]

  //TODO: Uncomment when ready chooseAChart.sort(() => Math.random() - 0.5)

  // Initialize Array to store the data
  let answers = []

  // Create svg for charts to be placed
  let svg = d3.select('#vis')

  // Create constant text for in experiment instructions
  const instructions = "Here are the instructions for this experiment"
  let label = document.getElementById('labelElement')

  // Create experiment in progress page
  function startButtonPress() {
    svg.append('svg')
            .attr('height', 500)
            .attr('width', 500)
    label.innerText = instructions
    document.getElementById('readyButton')
      .remove()

    // Create answer field
    let input = document.createElement("INPUT")
    input.setAttribute('id', 'textEntry')
    input.setAttribute('type', 'text')
    input.setAttribute('placeholder', 'Enter guess here!')
    document.body.appendChild(input)
    document.body.appendChild(document.createElement('br'))
    // TODO: Make the enter key press next button

    // Create next button
    let nextButton = document.createElement('button')
    nextButton.setAttribute('id', 'nextButton')
    nextButton.setAttribute('onclick', 'nextButtonPress()')
    nextButton.innerHTML = 'Next'
    document.body.appendChild(nextButton)

    input.addEventListener('keyup', function (event) {
      if (event.key === 'Enter') nextButton.click()
    })

    currTrialType = chooseAChart[currTrial](randomizeData(), randomizeSelectedPoints())
  }

  // What to do when next button is pressed
  function nextButtonPress() {
    let textEntry = document.getElementById('textEntry')
    // Check that the entry space isn't blank
      if (textEntry.value !== '') {
        // Store the recorded data

        let stats = calculateError(textEntry.value)
        answers.push({vis:currTrialType, truePercent:stats[0], reportedPercent:stats[1], error:stats[2]})

        // If this is the last trial change button to submit
        if (currTrial === chooseAChart.length - 1) document.getElementById('nextButton').innerHTML = 'Submit'

        // As long as we're not and the end of the list set up for next trial
        if (currTrial < chooseAChart.length - 1){
          currTrial++
          textEntry.value = ''
          currTrialType = chooseAChart[currTrial](randomizeData(), randomizeSelectedPoints())

        } else {
          label.innerText = 'Thanks for taking this thing, all done, refresh the page to restart'
          textEntry.remove()
          document.getElementById('nextButton').remove()

          console.log(answers)
          // TODO: Store the answers somewhere
        }

      } else {
        console.log('Ya gotta enter a value')
        //TODO: Make this a cool lil warning
      }
  }

  function calculateError(reportedPercentage) {
    // TODO: Make this clean up reportedPercentage if format is strange
    let truePercentage = Math.abs(currData[currSelectedPoints[0]] - currData[currSelectedPoints[1]])
    let error = Math.log2(Math.abs(reportedPercentage - truePercentage) + (1/8))
    if (error === -3) error = 0
    return [truePercentage, reportedPercentage, error]
  }

  // https://www.d3-graph-gallery.com/graph/treemap_json.html
  function makeTreeMap(arrayData, points) {
    const data = {children: arrayData.map(element => ({value: element}))}

    const root = d3.hierarchy(data).sum(function (d) {
      return d.value
    })

    d3.treemap()
      .size([498, 498])
      .paddingOuter(1)
      (root)

    svg
      .selectAll('rect')
      .data(root.leaves())
      .enter()
      .append('rect')
            .attr('x', function (d) { return d.x0; })
            .attr('y', function (d) { return d.y0; })
            .attr('width', function (d) { return d.x1 - d.x0; })
            .attr('height', function (d) { return d.y1 - d.y0; })
            .style("fill", "slateblue")

  }

  function makeStackedBarChart(data, points) {
    // TODO: This is a stub
    console.log('called makeStackedBarChart')
    console.log('Looking for points: ' + points)
    return 'Stacked Bar Chart'
  }

  function makePieChart(data, points) {
    // TODO: This is a stub
    console.log('called makePieChart')
    console.log('Looking for points: ' + points)
    return 'Pie Chart'
  }

  //Randomize data
  function randomizeData() {
    currData = [...Array(10)].map(() => Math.floor(Math.random() * 101))
    return currData
  }

  // select two data points
  function randomizeSelectedPoints() {
    currSelectedPoints = [...Array(2)].map(() => Math.floor(Math.random() * 10))
    while (currSelectedPoints[0] === currSelectedPoints[1]) {
      currSelectedPoints[1] = Math.floor(Math.random() * 10)
    }
    return currSelectedPoints
  }

</script>
