<!DOCTYPE html>
<html>

<head>
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet">

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      background-color: #f1f1f1;
    }

    #form {
      background-color: #ffffff;
      margin: 100px auto;
      font-family: Raleway;
      padding: 40px;
      width: 70%;
      min-width: 300px;
    }

    h1 {
      text-align: center;
    }

    input {
      padding: 10px;
      width: 100%;
      font-size: 17px;
      font-family: Raleway;
      border: 1px solid #aaaaaa;
    }

    /* Hide all steps by default: */
    .page {
      display: none;
    }

    button:hover {
      opacity: 0.8;
    }

    button {
      background-color: #1f75fe;
      color: #ffffff;
      border: none;
      padding: 10px 20px;
      font-size: 17px;
      font-family: Raleway;
      cursor: pointer;
    }
  </style>
</head>

<body>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script type='text/javascript' src='js/randomNumberGeneration.js'></script>

  <form id="form">

    <!-- One "tab" for each step in the form: -->
    <div class="page">
      <h1>Experiment</h1>
      <p>Thank you for agreeing to participate in our experiment!</p>
      <p>Through a series of questions we will be testing !!ourHypothesis!!</p>
      <p>Next pages will display different graphs. You will be asked to determine how different values compare
        percentage wise in size</p>
      <p>Click "Agree" button to start!</p>
    </div>

    <div class="page">
      <h3 id="questionHeader">QUESTION </h3>
      <svg id="vis"> </svg>
      <p>
        Two values are marked with dots on the visual above.
      </p>
      <p>
        What do you think the percent of the smaller value to the larger value is?
      </p>
      <p>Example: If you think the smaller value is half of the larger value, please input 50</p>
      <p>
        <input type="text" id="txtAnswer" />
      </p>
    </div>

    <div class="page">
      <h1> Thank you for your time! </h1>

    </div>

    <div style="overflow:auto;">
      <div style="float:right;">
        <button type="button" id="disagreeButon" onclick="disagree()">Disagree</button>
        <button type="button" id="saveNextButton" onclick="saveNext()">Next</button>
      </div>
    </div>

  </form>

  <script>
    //Initial SETUP
    console.log(d3);
    var tracker = 0;
    var numDisplay = 6; //Number of Display we want to have
    var currentPage = 0;
    var maxPage = 2;
    document.getElementById("disagreeButon").innerHTML = "Disagree";
    document.getElementById("saveNextButton").innerHTML = "Agree";
    display();


    var filepath = 'data.csv';
    var data = [{
      "participantID": 'elene',
      "trialNum": 0,
      "vis": 'bar',
      "truePercent": 75,
      "reportedPercent": 65
    }, {
      "participantID": 'elene',
      "trialNum": 0,
      "vis": 'bar',
      "truePercent": 75,
      "reportedPercent": 65
    }];
    var csvData = new Array();
    csvData.push('"participantID","trialNum","vis","truePercent","reportedPercent"\n"');

    function appendCSV() {
      data.forEach(function (item, index, array) {
        csvData.push(item.participantID + '","' + item.trialNum + '","' + item.vis + '","' + item.truePercent + '","' + item.reportedPercent + '"\n"');
      });

    }


    function end() {
      console.log("end");
      //write data to csv
      appendCSV();
      let csvContent = "data:text/csv;charset=utf-8 , " + csvData; //.map(e => e.join(",")).join("\n");

      var encodedUri = encodeURI(csvContent);
      var link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "my_data.csv");
      document.body.appendChild(link);
      link.click();
    }

    function generateBarGraph() {

      var svg = d3.select('#vis');
      svg.selectAll("*").remove();

      var width = 500,
      height = 500;

      svg
        .attr('width', 500)
        .attr('height', 500);
      

      console.log("bar");

      var numBars = 10;  //control number of bars

      //get random data
      var gen = barRandomGen();

      //need an array of JSON objects with x and y axis data
      var data = [];
      for (var i = 0; i < numBars; i++) {
        var newObj = { "xaxisdata": (i + 1), "yaxisdata": gen[0][i] };  //create JSON objects for array with numbers 1-10 on x axis and generated data on y axis
        data[i] = newObj;
      }

      //xaxis
      var x = d3.scaleBand()
        .range([0, width])
        .domain(data.map(function (d) { return d.xaxisdata; }));
      svg.append('g')
        .attr('transform', 'translate(0,' + height + ')')
        .call(d3.axisBottom(x))
        .selectAll('text')
        .attr('transform', 'translate(-10,0)rotate(-45)')
        .style('text-anchor', 'end');

      //yaxis
      var y = d3.scaleLinear()
        .domain([0, 100])
        .range([height, 0]);
      svg.append('g')
        .call(d3.axisLeft(y));

      //barchart plotting data
      svg.selectAll('mybar')
        .data(data)
        .enter()
        .append('rect')
        .attr('x', function (d) { return x(d.xaxisdata); })
        .attr('y', function (d) { return y(d.yaxisdata); })
        .attr('width', x.bandwidth())
        .attr('height', function (d) { return height - y(d.yaxisdata); })
        .attr('stroke', 'black')
        .attr('fill', 'white')
        .style('stroke-width', '2px');
      //we might have to add a dot maybe within the two random bars?

      var selectedBar1 = gen[1][0];  //index (btwn 0 and 9) of first selected bar for comparison
      var selectedBar2 = gen[1][1];  //index (btwn 0 and 9) of first selected bar for comparison

    }

    //generateBarGraph();
    
    function generatePieChart() {

      var svg = d3.select('#vis');
      svg.selectAll("*").remove();

      var width = 500;
      var height = 500;

      svg
        .attr('width', 500)
        .attr('height', 500)
        .append('g')
          .attr('transform', 'translate(' + width / 2 + ',' + height / 2 + ')');

      console.log("pie");

      var gen = pieRandomGen(); //generate random pie chart

      var data = gen[0];   //random numbers for pie slice values ready to go

      console.log(data);
      //Radius of pie chart is half the length of the width or height
      var radius = width / 2;


      var pie = d3.pie();


      svg.selectAll('mypie')
        .data(pie(data))
        .enter()
        .append('path')
        //We have to graph each arc of the data point
        .attr('d', d3.arc()
          .innerRadius(0)
          .outerRadius(radius))
        .attr('stroke', 'black')
        .attr('fill', 'white')
        .style('stroke-width', '2px');
      //we might have to add the dot?

      var selectedSlice1 = gen[1][0];  //index (btwn 0 and 9) of first selected pie slice for comparison
      var selectedSlice2 = gen[1][1];  //index (btwn 0 and 9) of second selected pie slice for comparison
    }

    generatePieChart();


    function generateStackedBarChart() {
      console.log("Stacked");


      //generate the random data
      var gen = stackedBarRandomGen();

      //assemble the data into array that d3 would like

      var bar1Obj = { "bar": 1, "val1": gen[1][0], "val2": gen[1][1], "val3": gen[1][2], "val4": gen[1][3], "val5": gen[1][4] };
      var bar2Obj = { "bar": 2, "val1": gen[4][0], "val2": gen[4][1], "val3": gen[4][2], "val4": gen[4][3], "val5": gen[4][4] };

      var data = [bar1Obj, bar2Obj];
      //this is essentially the same as a table with columns: bar, val1, val2, val3, val4, val5
      //where "bar" is just the bar number (1 or 2) and the vals are the sizes of the stacked pieces in each bar
      //each row in the table is one of the bars (bar 1 and bar 2)
      //I'm decently sure this is the structure that the code below wants for data

      //After we read in the data, we have to list the subgroups to be stacked
      var subgroups = data.columns.slice(1);

      //The first column here is set to be the x axis with the subgroups being the stacked bars
      //var groups  = d3.map(data, function(d){ return d.(/*first column name*/); }).keys()

      //xaxis
      var x = d3.scaleBand()
        .domain(groups)
        .range([0, width]);

      svg.append('g')
        .attr('transform', 'translate(0,' + height + ')')
        .call(d3.axisBottom(x).tickSizeOuter(0));

      //yaxis
      var y = d3.scaleLinear()
        //.domain([num, num])
        .range([height, 0]);
      svg.append('g')
        .call(d3.axisLeft(y));

      //color?? --> Would we need to add color here to differentiate the different subgroups?

      var stackedData = d3.stack()
        .keys(subgroups)(data);

      svg.append('g')
        .selectAll('g')
        .data(stackedData)
        .enter().append('g')
        //we would add the color here...
        .selectAll('rect')
        //we'd have to enter() more times depending on the subgroups to add all the necessary rectangles
        .data(function (d) {
          return d;
        })
        .enter().append('rect')
        //.attr('x', function(d) { return x(d.data.(/*first column name*/))})
        .attr('y', function (d) {
          return y(d[1]);
        })
        .attr('height', function (d) {
          return y(d[0] - y(d[1]));
        })
        .attr('width', x.bandwidth());

      var selectedPiece1 = gen[2];  //index (btwn 0 and 4) of selected element in first bar
      var selectedPiece2 = gen[5];  //index (btwn 0 and 4) of selected element in second bar
    }


    //function for calculating what the actual correct ratio percentage is given two values
    function calculateCorrectPercentage(val1, val2) {
      var largerVal = Math.max(val1, val2);
      var smallerVal = 0;
      if (largerVal == val1) {
        smallerVal = val2;
      } else {
        smallerVal = val1;
      }

      var correctPercentage = (smallerVal / largerVal) * 100;

      return correctPercentage;
    }

    function displayRandomGraph() {
      console.log("Display Random Graph");
      //save data
    }

    //ADD this
    function checkAnswers() {
      return true;
      //return false;
    }

    //display pages and buttons
    function display() {
      console.log("display   tracker " + tracker + "  currentPage " + currentPage);

      var p = document.getElementsByClassName("page");
      p[currentPage].style.display = "block";

      if (currentPage == maxPage) {
        document.getElementById("saveNextButton").innerHTML = "Download the results"; //.style.display = "Download";
      } else if (tracker == numDisplay) {
        document.getElementById("saveNextButton").innerHTML = "Finish and Save";
      } else if (currentPage > 0) {
        document.getElementById("saveNextButton").innerHTML = "Next";
      }

      document.getElementById("questionHeader").innerHTML = "Question " + tracker + "/" + numDisplay;
    }


    //Pressing Agree/Next/Save/Download button
    function saveNext() {
      //console.log("nextPrev currentPage " + currentPage)
      if (tracker == numDisplay + 1) {
        end();
        console.log("END")
        display();
        return false;
      }
      var p = document.getElementsByClassName("page");
      if (tracker == 0) {
        document.getElementById("disagreeButon").style.display = "none";
        p[currentPage].style.display = "none";
        currentPage = currentPage + 1;
      }
      if (tracker > 0 && tracker <= numDisplay) {
        if (!checkAnswers()) {
          console.log("EMPTYYYY");
          return false;
        }
        //add to data
        if (tracker == numDisplay) {
          p[currentPage].style.display = "none";
          currentPage = currentPage + 1;
        }

      }
      tracker = tracker + 1;
      display();
    }

    //Pressing Disagree Button
    function disagree() {
      var p = document.getElementsByClassName("page");
      p[currentPage].style.display = "none";
      currentPage = maxPage;
      document.getElementById("disagreeButon").style.display = "none";
      saveNext();
    }
  </script>

</body>

</html>