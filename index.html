<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="style.css" />
    <script src="https://d3js.org/d3.v4.min.js"></script>
  </head>

  <body>
    <div id="chart"></div>
    <h1>Experiment</h1>
    <div id="button">
      <!-- SO 47078563 -->
      <form onsubmit="return handleGuess()">
        <!-- Form to submit guess -->
        <p>What percent of the larger is the smaller?</p>

        <input type="text" id="box" />
        <input type="submit" value="Submit Guess" />
        <button onclick="download_csv()">Download CSV</button>
      </form>
    </div>
  </body>

  <script>
    console.log(d3); // test if d3 is loaded

    //magic numbers begone
    const NUM_DATAPOINTS = 6;

    // Initial Data
    sessionStorage.setItem("DATA", JSON.stringify(generateData()));
    sessionStorage.setItem("INDICIES", JSON.stringify(generateIndexes()));

    var guessList = []; // The list of user guess

    // Submit guess function, add guess to list
    function submitGuess() {
      guess = document.getElementById("box").value;
      guessList.push(guess); // add guess  to list
      document.getElementById("box").value = ""; //clear the input box
      sessionStorage.setItem("guessList", JSON.stringify(guessList));
      console.log(JSON.parse(sessionStorage.getItem("guessList"))); // console log sanity
      return false; // dont reload form
    }

    // Handle the guess button
    function handleGuess() {
      // Submit the guess
      submitGuess();

      // Get new data
      sessionStorage.setItem("DATA", JSON.stringify(generateData()));
      sessionStorage.setItem("INDICIES", JSON.stringify(generateIndexes()));

      return false;
    }

    // Download the CSV file
    function download_csv() {
      var csv = Array.prototype.join.call(
        JSON.parse(sessionStorage.getItem("guessList")),
        ",\n"
      );

      filename = "guesses.csv";

      if (!csv.match(/^data:text\/csv/i)) {
        csv = "data:text/csv;charset=utf-8," + csv;
      }
      data = encodeURI(csv);

      link = document.createElement("a");
      link.setAttribute("href", data);
      link.setAttribute("download", filename);
      link.click();
    }

    function getRandomInt(max) {
      return Math.floor(Math.random() * Math.floor(max));
    }

    function generateData() {
      var datapoints = [];
      for (i = 0; i < NUM_DATAPOINTS; i++) {
        datapoints.push(getRandomInt(100) + 1);
      }
      return datapoints;
    }

    // Generate indecies while avoiding duplicates
    function generateIndexes() {
      var indexes = [];
      var chosenInt;
      while (indexes.length < 2) {
        chosenInt = getRandomInt(6);
        if (!indexes.includes(chosenInt)) {
          indexes.push(chosenInt);
        }
      }
      return indexes;
    }

    function generateRatio(datapoints, indexes) {
      var ratio;
      if (datapoints[indexes[0]] > datapoints[indexes[1]]) {
        ratio = (datapoints[indexes[1]] / datapoints[indexes[0]]) * 100;
      } else ratio = (datapoints[indexes[0]] / datapoints[indexes[1]]) * 100;
      sessionStorage.setItem("someRatio", ratio);
      return ratio;
    }
  </script>

  <!-- State thing script -->
  <script>
    //Setup that JS global state machine
    sessionStorage.setItem("PAGE", "SANKEY");

    // Call the initial handle
    handlePage();

    function guessStore(guess, actual) {
      theGuess = [guess, actual];
      console.log("Stored guess: " + guess + ", actual: " + actual);
      sessionStorage.setItem("guess", theGuess);
    }

    // Set the page to PAGE input, in string, and call handlePage
    function setPage(PAGE) {
      sessionStorage.setItem("PAGE", PAGE);
      console.log("Set to " + PAGE);
      handlePage();
    }

    // Check the current set page, and if it is know set the div to that page
    function handlePage() {
      switch (sessionStorage.getItem("PAGE")) {
        case "BUBBLE":
          document.getElementById("chart").innerHTML =
            "<object type='text/html' id='object-design' data ='bubbles.html'></object>";
          break;
        case "BAR":
          document.getElementById("chart").innerHTML =
            "<object type='text/html' id='object-design' data ='bargraph.html'></object>";
          break;
        case "SANKEY":
          document.getElementById("chart").innerHTML =
            "<object type='text/html' id='object-design' data ='sankey.html'></object>";
          break;
        default:
          console.log("Default handle, no predefined page");
      }
    }

    // Sample guess storage and attempts
    guessStore(42, 50);
    console.log(sessionStorage.getItem("guess"));
  </script>
</html>
