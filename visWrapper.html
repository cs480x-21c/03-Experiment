<html>
    <head>
        <link rel="stylesheet" type="text/css" href="stylesheet.css">
        <script src="https://d3js.org/d3.v6.min.js"></script>
    </head>

    <body>
        <div id="trialCounter">
            <!-- Trial 0/20 -->
        </div>

        <!-- Hold visualizations -->
        <div id="visDiv"></div>

        <!-- Input form -->
        <div id="input-submit">
            <form class="input-form">
                <label for="input-text" class="answerTxt"> Answer: </label>
                <input type="text" id="input-text">
                <input type="button" id="submit-button" value="Next"/>
            </form>
           
        </div>
    </body>

    <script>
        var lineData = [["10%", 40], ["50%", 40], ["90%", 40]]

        var svg = d3.select("#trialCounter")
        .append('svg')
        .attr("width", "100%")
        .attr("height", 80)

        svg.append("circle")
        .attr("cx", "10%")
        .attr("cy", 30)
        .attr("r", 20)
        .attr("id", "barProgress")
        .attr("fill", "none")
        .style("stroke-width", 1.5)
        .style("stroke", "black")
        
        svg.append("circle")
        .attr("cx", "50%")
        .attr("cy", 30)
        .attr("r", 20)
        .attr("id", "angleProgress")
        .attr("fill", "none")
        .style("stroke-width", 1.5)
        .style("stroke", "black")
        
        svg.append("circle")
        .attr("cx", "90%")
        .attr("cy", 30)
        .attr("r", 20)
        .attr("id", "volProgress")
        .attr("fill", "none")
        .style("stroke-width", 1.5)
        .style("stroke", "black")

        svg.append("line")           
        .style("stroke", "black")  
        .style("stroke-width", 1.5) 
        .attr("x1", "13.75%")        
        .attr("y1", 32.5)     
        .attr("x2", "46.25%")       
        .attr("y2", 32.5)     
        
        svg.append("line")           
        .style("stroke", "black")  
        .style("stroke-width", 1.5) 
        .attr("x1", "53.75%")        
        .attr("y1", 32.5)     
        .attr("x2", "86.25%")       
        .attr("y2", 32.5)

        svg.append("text")
        .text("Bar")
        .attr("dy", "1em")
        .attr("x", "7.5%")
        .attr("y", 60)
        .attr("font-family", '"Roboto", sans-serif')
    
        svg.append("text")
        .text("Angle")
        .attr("dy", "1em")
        .attr("x", "46.5%")
        .attr("y", 60)

        svg.append("text")
        .text("Volume")
        .attr("dy", "1em")
        .attr("x", "85%")
        .attr("y", 60)

        function updateProgress(progressId) {
            var id = "#" + progressId
            d3.select(id).attr("fill", "#6495ed")
        }

        var next = null;
        var counter = 0;
        var testCounter = 0;
        var isFinished = false;
        sessionStorage.setItem("vertical", "true")
        let userAnswers = []
        let actualAnswers = []
        let actualAnswersVolume = []

        if(testCounter == 0){
            switchChart();
        }

        function nextButton(){
            // Get + clear input
            let input = document.getElementById("input-text").value;
            userAnswers.push(1)
            let resetText = document.getElementById("input-text");
            resetText.value = ""

            // Decide vert vs hor barchart
            if (next = "barchart.html") {
                if (testCounter === 10) {
                    sessionStorage.setItem("vertical", "false")
                }
            }
            //console.log("user answers from text field: " + userAnswers)
            switchChart()
        }

        function switchChart() {
                //console.log(testCounter);
                switch (counter) {
                    case 0:
                        testCounter+=1;
                        next = "barchart.html";
                        if(testCounter == 20){
                            isFinished = true;
                            testCounter = 0;
                            counter += 1;
                        }  
                        break;
                    case 1:
                        updateProgress("barProgress")
                        testCounter+=1;
                        next = "tilt-angle.html";
                        if(testCounter == 20){
                            isFinished = true;
                            testCounter = 0;
                            counter += 1;
                        }  

                        break;
                    case 2:
                        updateProgress("angleProgress")
                        testCounter+=1;
                        next = "volume.html";
                        if(testCounter == 20){
                            isFinished = true;
                            testCounter = 0;
                            counter += 1;
                        }
                        break;
                    case 3:
                        updateProgress("volProgress")
                        next = "finished.html";
                        document.getElementById("submit-button").disabled = true;
                        var div = document.getElementById("input-submit");
                        div.style.visibility = "hidden"
                        div.style.display = "none";
                        isFinished = true;
                        parseData()
                        break;
                    default:
                        break;
                }
                document.getElementById("visDiv").innerHTML = "<object type='text/html' id='object-design' data ='" + next + "'></object>";
                isFinished = false;
                // console.log(sessionStorage.getItem("actualAnswer"))
                
                if (counter == 2) {
                actualAnswersVolume.push(sessionStorage.getItem("actualAnswerVolume")) 
                console.log(sessionStorage.getItem("actualAnswerVolume"))
                } else {
                    actualAnswers.push(sessionStorage.getItem("actualAnswer"))
                }
                //console.log("actual answers from html: " + actualAnswers)
        }

        function parseData() {
            let barchartData = [];
            let angleData = [];
            let volumeData = [];

            for (let i = 0 ; i < 20 ; i++) {

                    barchartData.push([actualAnswers[i], userAnswers[i]]);
                }
            for  (let i = 0; i < 20; i++) {
                    //console.log("actual angle answer " + actualAnswers[i])
                    angleData.push([actualAnswers[i], userAnswers[i]]);
                }
            for (let i = 0 ; i < 20 ; i++ ) {
                volumeData.push([actualAnswersVolume[i], userAnswers[i]]);
                }

            // console.log(volumeData)
            //console.log("barchart" + barchartData)
            console.log(angleData)
            //console.log("volume" + volumeData)

            let rows = [["ParticipantID", "TrialNum", "Vis", "TruePercent", "ReportedPercent"]]

            //generate paticipantID
            //generate trialnum
            //get vis
            let randomID = "Test" + Math.floor(Math.random() * 100)
            //fill barchart vert

            for(let i = 0; i < 10; i++){

                rows.push([randomID, i, "barchart_vert", barchartData[i][0], barchartData[i][1]])
            }
            //fill barchart hor
            for(let i = 10; i < 20; i++){

                rows.push([randomID, i, "barchart_hor", barchartData[i][0], barchartData[i][1]])
            }
            //fill angle
            for(let i = 0; i < 20; i++){

                rows.push([randomID, i, "angles", angleData[i][0], angleData[i][1]])
            }
            //fill volume
            for(let i = 0; i < 20; i++){

                rows.push([randomID, i, "volume", volumeData[i][0], volumeData[i][1]])
            }

            console.log(rows);



            let csvContent = "data:text/csv;charset=utf-8,"

            rows.forEach(function(rowArray) {
                let row = rows.join(",");
                csvContent += row + "\r\n";
            });

            var d = new Date();
            var n = d.getTime();

            var encodedUri = encodeURI(csvContent);
            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", n.toString() + ".csv");
            document.body.appendChild(link); 

            link.click(); 
        }



        document.getElementById("submit-button").addEventListener("click", nextButton);
    
    </script>
</html>


