<html>
    <head>
        <link rel="stylesheet" type="text/css" href="stylesheet.css">
    </head>

    <body>
        <!-- Hold visualizations -->
        <div id="visDiv"></div>

        <!-- Input form -->
        <div id="input-submit">
            <form class="input-form">
                <label for="input-text"> Answer: </label>
                <input type="text" id="input-text">
                <input type="button" id="submit-button" value="Next"/>
            </form>
        </div>
    </body>

    <script>       
        var next = null;
        var counter = 0;
        var testCounter = 0;
        var isFinished = false;
        sessionStorage.setItem("vertical", "true")
        let userAnswers = []
        let actualAnswers = []

        if(testCounter == 0){
            switchChart();
        }

        function nextButton(){
            // Get + clear input
            let input = document.getElementById("input-text").value;
            userAnswers.push(1)
            let resetText = document.getElementById("input-text");
            resetText.value = ""

            // Decide vert vs hor barchart
            if (next = "barchart.html") {
                if (testCounter === 10) {
                    sessionStorage.setItem("vertical", "false")
                }
            }
            //console.log("user answers from text field: " + userAnswers)
            switchChart()
        }

        function switchChart() {
                //console.log(testCounter);
                switch (counter) {
                    case 0:
                        testCounter+=1;
                        next = "barchart.html";
                        if(testCounter == 20){
                            isFinished = true;
                            testCounter = 0;
                            counter += 1;
                        }  
                        break;
                    case 1:
                        testCounter+=1;
                        next = "tilt-angle.html";
                        if(testCounter == 20){
                            isFinished = true;
                            testCounter = 0;
                            counter += 1;
                        }  

                        break;
                    case 2:
                        testCounter+=1;
                        next = "volume.html";
                        if(testCounter == 20){
                            isFinished = true;
                            testCounter = 0;
                            counter += 1;
                        }
                        break;
                    case 3:
                        next = "finished.html";
                        parseData()
                        break;
                    default:
                        break;
                }
                document.getElementById("visDiv").innerHTML = "<object type='text/html' id='object-design' data ='" + next + "'></object>";
                isFinished = false;
                // console.log(sessionStorage.getItem("actualAnswer"))
                actualAnswers.push(sessionStorage.getItem("actualAnswer"))
                //console.log("actual answers from html: " + actualAnswers)
        }

        function parseData() {
            let barchartData = [];
            let angleData = [];
            let volumeData = [];

            for (let i = 0 ; i < 60 ; i++) {
                if (i < 20) {
                    barchartData.push([actualAnswers[i], userAnswers[i]]);
                } else if (i > 20 && i < 40) {
                    console.log("actual angle answer " + actualAnswers[i])
                    angleData.push([actualAnswers[i], userAnswers[i]]);
                } else if (i > 40) {
                    volumeData.push([actualAnswers[i], userAnswers[i]]);
                }
            }
            //console.log("barchart" + barchartData)
            //console.log("angle" + angleData)
            //console.log("volume" + volumeData)

            let rows = [["ParticipantID", "TrialNum", "Vis", "TruePercent", "ReportedPercent"]]

            //generate paticipantID
            //generate trialnum
            //get vis
            let randomID = "User" + Math.floor(Math.random() * 100)
            //fill barchart vert
            for(let i = 0; i < 10; i++){

                rows.push([randomID, i, "barchart_vert", barchartData[i][0], barchartData[i][1]])
            }
            //fill barchart hor
            for(let i = 10; i < 20; i++){

                rows.push([randomID, i, "barchart_hor", barchartData[i][0], barchartData[i][1]])
            }
            //fill angle
            for(let i = 20; i < 40; i++){

                rows.push([randomID, i, "angles", angleData[i][0], angleData[i][1]])
            }
            //fill volume
            for(let i = 40; i < 60; i++){

                rows.push([randomID, i, "angles", volumeData[i][0], volumeData[i][1]])
            }

            console.log(rows);



            let csvContent = "data:text/csv;charset=utf-8,"

            rows.forEach(function(rowArray) {
                let row = rows.join(",");
                csvContent += row + "\r\n";
            });

            var encodedUri = encodeURI(csvContent);
            var link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "test.csv");
            document.body.appendChild(link); // Required for FF

            link.click(); // This will download the data file named "my_data.csv".
        }



        document.getElementById("submit-button").addEventListener("click", nextButton);
    
    </script>
</html>


